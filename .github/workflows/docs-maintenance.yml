name: Documentation Maintenance

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - '**.md'
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cspell
        run: npm install -g cspell

      - name: Run spell check
        run: cspell --no-progress "docs/**/*.md" "*.md"

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: |
            docs/**/*.md
            *.md
            !node_modules

  link-check:
    name: Link Check
    runs-on: ubuntu-latest
    # Only run on push to main or scheduled, not on every PR
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Generate TypeDoc
        run: pnpm docs

      - name: Build VitePress
        run: pnpm docs:build

      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: >
            --verbose
            --no-progress
            --accept 200,204,206,301,302,307,308
            --exclude-mail
            --exclude 'localhost'
            --exclude '127.0.0.1'
            --exclude 'example.com'
            --exclude 'plausible.io'
            --exclude 'usefathom.com'
            --exclude 'simpleanalytics.com'
            --exclude 'twitter.com'
            --exclude 'linkedin.com'
            --exclude 'cards-dev.twitter.com'
            --exclude-path './docs/.vitepress/dist/assets'
            './docs/.vitepress/dist/**/*.html'
          fail: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload link check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: ./lychee/out.md
          retention-days: 30
